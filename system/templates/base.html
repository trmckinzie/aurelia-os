<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}Aurelia OS{% endblock %}</title>
    <meta name="description" content="{{ config.author.bio_short }}">
    <meta name="author" content="{{ config.author.name }}">
    
    <meta property="og:title" content="{{ config.system_name }}">
    <meta property="og:description" content="{{ config.author.bio_short }}">
    <meta property="og:image" content="assets/images/social-preview.jpg"> 
    <meta property="og:type" content="website">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ </text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    ```


    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          // SEMANTIC MAPPING
          'aurelia-bg': {{ theme.colors.bg_main }},
          'aurelia-card': {{ theme.colors.bg_layer_1 }},
          'aurelia-surface': {{ theme.colors.bg_layer_2 }},
          
          'aurelia-text': {{ theme.colors.text_main }},
          'aurelia-muted': {{ theme.colors.text_muted }},
          'aurelia-inverted': {{ theme.colors.text_inverted }},

          'aurelia-border': {{ theme.colors.border_main }},
          
          // ROLES
          'aurelia-primary': {{ theme.colors.primary }},
          'aurelia-secondary': {{ theme.colors.secondary }},
          'aurelia-tertiary': {{ theme.colors.tertiary }},
          'aurelia-accent': {{ theme.colors.accent }},
        },
        borderRadius: {
            'theme': {{ theme.rounded }}
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          mono: [{{ theme.font_mono }}],
        },
        {% if theme.name == 'CYBER_PRIME' %}
        animation: { 'scanline': 'scanline 8s linear infinite' },
        {% endif %}
      }
    }
  }
</script>

<style>
    /* NAV BAR GLOW UTILITIES */
    .text-shadow-cyan { text-shadow: 0 0 10px {{ theme.colors.primary|replace("'", "") }}80; }
    .text-shadow-green { text-shadow: 0 0 10px {{ theme.colors.accent|replace("'", "") }}80; }
    .text-shadow-purple { text-shadow: 0 0 10px {{ theme.colors.secondary|replace("'", "") }}80; }
    .text-shadow-orange { text-shadow: 0 0 10px {{ theme.colors.tertiary|replace("'", "") }}80; }
    .text-shadow-white { text-shadow: 0 0 10px rgba(255,255,255,0.5); }

    /* GLOBAL RESET */
    body { 
        background-color: {{ theme.colors.bg_main|replace("'", "") }}; 
        color: {{ theme.colors.text_main|replace("'", "") }};
    }
    
/* GLOBAL SELECTION HIGHLIGHTER */
    ::selection {
        background: {{ theme.colors.primary|replace("'", "") }}; /* Cyan in Cyber Prime */
        color: {{ theme.colors.bg_main|replace("'", "") }};      /* Black Text for contrast */
        text-shadow: none; /* Removes glow for cleaner reading */
    }

    /* Firefox Support */
    ::-moz-selection {
        background: {{ theme.colors.primary|replace("'", "") }};
        color: {{ theme.colors.bg_main|replace("'", "") }};
        text-shadow: none;
    }

    /* UNIVERSAL GLASS CLASS */
    .glass {
        background: rgba(10, 10, 11, {{ theme.glass_opacity|replace("'", "") }});
    }
    
    /* THE_PATRIOT SPECIFIC OVERRIDE FOR GLASS */
    {% if theme.name == 'THE_PATRIOT' %}
    .glass {
        background: white;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    /* Invert the scanline/grid to be subtle gray on white */
    .scanline {
        background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 1px,
            #e5e7eb 1px,
            #e5e7eb 2px
        );
        opacity: 0.3;
    }
    {% endif %}

    /* --- [NEW] GLOBAL PROSE DEFAULTS --- */
    /* This makes all Markdown content follow the active theme colors automatically */
    .prose {
        color: {{ theme.colors.text_muted|replace("'", "") }};
        max-width: 65ch; /* Optimal reading width */
    }
    .prose h1, .prose h2, .prose h3, .prose h4, .prose strong {
        color: {{ theme.colors.text_main|replace("'", "") }};
    }
    .prose a {
        color: {{ theme.colors.primary|replace("'", "") }};
        text-decoration: none;
        border-bottom: 1px dotted {{ theme.colors.primary|replace("'", "") }};
    }
    .prose a:hover {
        color: {{ theme.colors.accent|replace("'", "") }};
        border-bottom-style: solid;
    }
    .prose code {
        color: {{ theme.colors.accent|replace("'", "") }};
        background: {{ theme.colors.bg_layer_2|replace("'", "") }};
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .prose blockquote {
        border-left-color: {{ theme.colors.primary|replace("'", "") }};
        color: {{ theme.colors.text_muted|replace("'", "") }};
    }
</style>
    {% block head_extra %}{% endblock %}
</head>
<body class="text-aurelia-text font-sans selection:bg-aurelia-cyan selection:text-aurelia-inverted overflow-x-hidden min-h-screen flex flex-col">
    
    <div class="scanline"></div>

    <nav class="fixed top-0 w-full z-50 border-b border-aurelia-border/40 bg-aurelia-bg/90 backdrop-blur-md h-16 transition-all duration-300">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex items-center justify-between font-mono text-[10px] tracking-[0.2em]">
            
            <a href="index.html" class="flex items-center gap-3 group">
                <div class="relative flex items-center justify-center">
                    <div class="absolute w-3 h-3 border border-aurelia-primary/30 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                    <div class="w-1.5 h-1.5 bg-aurelia-primary rounded-full shadow-[0_0_10px_rgba(0,242,255,0.8)] animate-pulse"></div>
                </div>
                <span class="text-aurelia-text font-bold group-hover:text-aurelia-primary transition-colors duration-300">
                    AURELIA_OS // <span class="opacity-50">{% block nav_title %}HUB{% endblock %}</span>
                </span>
            </a>   

            <div class="hidden md:flex items-center gap-10">
                
                <a href="index.html" class="relative group py-2">
                    <span class="{% if active_page == 'index' %}text-aurelia-text text-shadow-white{% else %}text-aurelia-muted hover:text-aurelia-text{% endif %} transition-all duration-300">00_LOBBY</span>
                    <span class="absolute -bottom-1 left-0 w-full h-[1px] bg-aurelia-text transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left {% if active_page == 'index' %}scale-x-100{% endif %}"></span>
                </a>

                <a href="garden.html" class="relative group py-2">
                    <span class="{% if active_page == 'garden' %}text-aurelia-primary text-shadow-cyan{% else %}text-aurelia-muted hover:text-aurelia-primary hover:text-shadow-cyan{% endif %} transition-all duration-300">01_GARDEN</span>
                    <span class="absolute -bottom-1 left-0 w-full h-[1px] bg-aurelia-primary transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left {% if active_page == 'garden' %}scale-x-100{% endif %}"></span>
                </a>

                <a href="protocol.html" class="relative group py-2">
                    <span class="{% if active_page == 'protocol' %}text-aurelia-accent text-shadow-green{% else %}text-aurelia-muted hover:text-aurelia-accent hover:text-shadow-green{% endif %} transition-all duration-300">02_PROTOCOLS</span>
                    <span class="absolute -bottom-1 left-0 w-full h-[1px] bg-aurelia-accent transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left {% if active_page == 'protocol' %}scale-x-100{% endif %}"></span>
                </a>

                <a href="portfolio.html" class="relative group py-2">
                    <span class="{% if active_page == 'portfolio' %}text-aurelia-secondary text-shadow-purple{% else %}text-aurelia-muted hover:text-aurelia-secondary hover:text-shadow-purple{% endif %} transition-all duration-300">03_PORTFOLIO</span>
                    <span class="absolute -bottom-1 left-0 w-full h-[1px] bg-aurelia-secondary transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left {% if active_page == 'portfolio' %}scale-x-100{% endif %}"></span>
                </a>

                <a href="services.html" class="relative group py-2">
                    <span class="{% if active_page == 'services' %}text-aurelia-tertiary text-shadow-orange{% else %}text-aurelia-muted hover:text-aurelia-tertiary hover:text-shadow-orange{% endif %} transition-all duration-300">04_SERVICES</span>
                    <span class="absolute -bottom-1 left-0 w-full h-[1px] bg-aurelia-tertiary transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left {% if active_page == 'services' %}scale-x-100{% endif %}"></span>
                </a>

            </div>
            
            <button class="md:hidden text-aurelia-text">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
    </nav>

    <main class="flex-grow pt-32 pb-20 px-6 w-full max-w-[1600px] mx-auto">
        {% block content %}{% endblock %}
    </main>

    <footer class="border-t border-aurelia-dim bg-aurelia-bg/80 backdrop-blur py-6 mt-20 relative z-30">
        <div class="max-w-[1600px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4 text-[14px] font-mono tracking-widest text-aurelia-muted">
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 bg-aurelia-cyan rounded-full animate-pulse"></div>
                <span class="text-aurelia-cyan">{{ config.system_name }} SYSTEM</span>
            </div>
            <div class="text-aurelia-text">// {{ config.author.bio_short }}</div>
            <div class="flex gap-6 uppercase">
                <span class="text-aurelia-cyan">{{ config.system_version }}</span>
                <span>SECURE</span>
            </div>
        </div>
    </footer>

    {% block scripts %}{% endblock %}

    <div id="cmd-backdrop" class="fixed inset-0 bg-aurelia-bg/80 backdrop-blur-sm z-[100] hidden transition-opacity duration-200 opacity-0">
        <div id="cmd-panel" class="w-full max-w-2xl mx-auto mt-20 bg-[#0a0a0b] border border-aurelia-border shadow-[0_0_50px_rgba(0,0,0,0.5)] rounded-lg overflow-hidden transform scale-95 transition-all duration-200">
            
            <div class="flex items-center px-4 border-b border-aurelia-border">
                <span class="text-aurelia-cyan text-xl mr-3 font-mono">></span>
                <input type="text" id="cmd-input" placeholder="Initiate Neural Query..." class="w-full h-16 bg-transparent text-aurelia-text font-mono text-lg focus:outline-none placeholder-gray-600">
                <div class="hidden md:flex gap-1">
                    <span class="text-[10px] font-mono text-aurelia-muted border border-aurelia-border px-1 rounded">ESC</span>
                </div>
            </div>

            <div id="cmd-results" class="max-h-[60vh] overflow-y-auto p-2">
                </div>

            <div class="px-4 py-2 bg-aurelia-bg/50 border-t border-aurelia-border flex justify-between items-center text-[10px] font-mono text-aurelia-muted">
                <span>AURELIA_INDEX_V3.2</span>
                <span id="cmd-count">0 NODES CONNECTED</span>
            </div>
        </div>
    </div>

    <script>
        /* --- COMMAND PALETTE LOGIC --- */
        // 1. Ingest the Python-generated Index (Safe injection)
        const SYSTEM_INDEX = {{ search_index | safe }}; 
        
        const cmdBackdrop = document.getElementById('cmd-backdrop');
        const cmdPanel = document.getElementById('cmd-panel');
        const cmdInput = document.getElementById('cmd-input');
        const cmdResults = document.getElementById('cmd-results');
        const cmdCount = document.getElementById('cmd-count');
        let isOpen = false;

        // Update footer count
        if(cmdCount) cmdCount.innerText = `${SYSTEM_INDEX.length} NODES CONNECTED`;

        // 2. Open/Close Logic
        function toggleCmd() {
            isOpen = !isOpen;
            if(isOpen) {
                cmdBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    cmdBackdrop.classList.remove('opacity-0');
                    cmdPanel.classList.remove('scale-95');
                    cmdPanel.classList.add('scale-100');
                    cmdInput.focus();
                }, 10);
                document.body.style.overflow = 'hidden';
            } else {
                cmdBackdrop.classList.add('opacity-0');
                cmdPanel.classList.remove('scale-100');
                cmdPanel.classList.add('scale-95');
                setTimeout(() => {
                    cmdBackdrop.classList.add('hidden');
                    cmdInput.value = ''; // Clear input
                    renderResults([]); // Clear results
                }, 200);
                document.body.style.overflow = 'auto';
            }
        }

        // 3. Event Listeners (CMD+K)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                toggleCmd();
            }
            if (e.key === 'Escape' && isOpen) toggleCmd();
        });

        // Close on click outside
        cmdBackdrop.addEventListener('click', (e) => {
            if(e.target === cmdBackdrop) toggleCmd();
        });

        // 4. Search Engine (UPDATED)
        cmdInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if(query.length < 1) {
                cmdResults.innerHTML = `<div class="text-center py-8 text-aurelia-muted font-mono text-sm opacity-50">... AWAITING INPUT ...</div>`;
                return;
            }

            // SMART FILTER: Checks Title, Type, AND Tags
            const matches = SYSTEM_INDEX.filter(item => {
                const titleMatch = item.title.toLowerCase().includes(query);
                const typeMatch = item.type.toLowerCase().includes(query);
                const tagMatch = item.tags && item.tags.some(t => t.toLowerCase().includes(query));
                const descMatch = item.desc && item.desc.toLowerCase().includes(query);
                
                return titleMatch || typeMatch || tagMatch || descMatch;
            }).slice(0, 8);

            renderResults(matches);
        });

        function renderResults(results) {
            if(results.length === 0 && cmdInput.value.length > 0) {
                cmdResults.innerHTML = `<div class="p-4 text-center font-mono text-aurelia-muted">> NO_MATCHES_FOUND_IN_VAULT</div>`;
                return;
            }

            // Render List
            cmdResults.innerHTML = results.map((item, index) => {
                // Color coding based on type
                let typeColor = "text-aurelia-muted border-aurelia-border";
                if(item.type === "PROJECT") typeColor = "text-aurelia-purple border-aurelia-purple/50";
                if(item.type === "GARDEN" || item.type === "NOTE") typeColor = "text-aurelia-cyan border-aurelia-cyan/50";
                if(item.type === "PROTOCOL") typeColor = "text-aurelia-green border-aurelia-green/50";
                
                return `
                <a href="${item.url}" class="group flex items-center justify-between p-3 rounded-md hover:bg-aurelia-text/5 hover:border-l-2 hover:border-aurelia-cyan cursor-pointer transition-all border-l-2 border-transparent">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-mono uppercase px-1.5 py-0.5 rounded border ${typeColor} w-20 text-center">
                            ${item.type}
                        </span>
                        <span class="font-bold text-aurelia-text group-hover:text-aurelia-text font-mono">${item.title}</span>
                    </div>
                    <span class="text-aurelia-muted text-xs font-mono group-hover:text-aurelia-cyan">JUMP -></span>
                </a>
                `;
            }).join('');
        }
    </script>
</body>
</html>