<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}Aurelia OS{% endblock %}</title>
    <meta name="description" content="{{ config.author.bio_short }}">
    <meta name="author" content="{{ config.author.name }}">
    
    <meta property="og:title" content="{{ config.system_name }}">
    <meta property="og:description" content="{{ config.author.bio_short }}">
    <meta property="og:image" content="assets/images/social-preview.jpg"> 
    <meta property="og:type" content="website">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ </text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    ```


    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          // MAPPED ROLES
          'aurelia-bg': {{ theme.colors.bg_main }},
          'aurelia-dim': {{ theme.colors.bg_dim }},
          'aurelia-text': {{ theme.colors.text_main }},
          'aurelia-text-dim': {{ theme.colors.text_dim }},
          
          'aurelia-primary': {{ theme.colors.primary }},   // Replaces Cyan
          'aurelia-secondary': {{ theme.colors.secondary }}, // Replaces Purple
          'aurelia-tertiary': {{ theme.colors.tertiary }},  // Replaces Orange
          'aurelia-accent': {{ theme.colors.accent }},      // Replaces Green
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          mono: [{{ theme.font_mono }}],
        },
        {% if theme.bg_scanline == 'true' %}
        animation: { 'scanline': 'scanline 8s linear infinite' },
        {% endif %}
      }
    }
  }
</script>

<style>
  /* GLOBAL OVERRIDES */
  body { 
    background-color: {{ theme.colors.bg_main|replace("'", "") }}; 
    color: {{ theme.colors.text_dim|replace("'", "") }};
  }
  
  /* DYNAMIC CURSOR (Follows Accent Color) */
  a, button, .clickable {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='9' fill='none' stroke='{{ theme.colors.accent|replace("'", "")|replace("#", "%23") }}' stroke-width='1.5'/%3E%3Ccircle cx='12' cy='12' r='2' fill='{{ theme.colors.accent|replace("'", "")|replace("#", "%23") }}'/%3E%3C/svg%3E") 12 12, pointer !important;
  }
</style>
    {% block head_extra %}{% endblock %}
</head>
<body class="text-gray-300 font-sans selection:bg-aurelia-cyan selection:text-black overflow-x-hidden min-h-screen flex flex-col">
    
    <div class="scanline"></div>

    <nav class="fixed top-0 w-full z-50 border-b border-aurelia-dim bg-aurelia-dark/95 backdrop-blur-xl h-14">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex items-center justify-between font-mono text-[10px] tracking-[0.2em]">
            <a href="index.html" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <div class="w-2 h-2 {% block nav_dot_color %}bg-aurelia-cyan{% endblock %} rounded-full shadow-[0_0_8px_currentColor] animate-pulse"></div>
                <span class="text-white font-bold">AURELIA_OS // {% block nav_title %}HUB{% endblock %}</span>
            </a>   
            <div class="hidden md:flex gap-8 uppercase">
                <a href="index.html" class="{% if active_page == 'index' %}text-white border-b border-white pb-1{% else %}hover:text-white transition-colors{% endif %}">00_LOBBY</a>
                <a href="garden.html" class="{% if active_page == 'garden' %}text-aurelia-cyan border-b border-aurelia-cyan pb-1{% else %}hover:text-aurelia-cyan transition-colors{% endif %}">01_GARDEN</a>
                <a href="protocol.html" class="{% if active_page == 'protocol' %}text-aurelia-green border-b border-aurelia-green pb-1{% else %}hover:text-aurelia-green transition-colors{% endif %}">02_PROTOCOLS</a>
                <a href="portfolio.html" class="{% if active_page == 'portfolio' %}text-aurelia-purple border-b border-aurelia-purple pb-1{% else %}hover:text-aurelia-purple transition-colors{% endif %}">03_PORTFOLIO</a>
                <a href="services.html" class="{% if active_page == 'services' %}text-aurelia-orange border-b border-aurelia-orange pb-1{% else %}hover:text-aurelia-orange transition-colors{% endif %}">04_SERVICES</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow pt-32 pb-20 px-6 w-full max-w-[1600px] mx-auto">
        {% block content %}{% endblock %}
    </main>

    <footer class="border-t border-aurelia-dim bg-black/80 backdrop-blur py-6 mt-20 relative z-30">
        <div class="max-w-[1600px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4 text-[14px] font-mono tracking-widest text-gray-600">
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 bg-aurelia-cyan rounded-full animate-pulse"></div>
                <span class="text-aurelia-cyan">{{ config.system_name }} SYSTEM</span>
            </div>
            <div class="text-gray-300">// {{ config.author.bio_short }}</div>
            <div class="flex gap-6 uppercase">
                <span class="text-aurelia-cyan">{{ config.system_version }}</span>
                <span>SECURE</span>
            </div>
        </div>
    </footer>

    {% block scripts %}{% endblock %}

    <div id="cmd-backdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden transition-opacity duration-200 opacity-0">
        <div id="cmd-panel" class="w-full max-w-2xl mx-auto mt-20 bg-[#0a0a0b] border border-gray-800 shadow-[0_0_50px_rgba(0,0,0,0.5)] rounded-lg overflow-hidden transform scale-95 transition-all duration-200">
            
            <div class="flex items-center px-4 border-b border-gray-800">
                <span class="text-aurelia-cyan text-xl mr-3 font-mono">></span>
                <input type="text" id="cmd-input" placeholder="Initiate Neural Query..." class="w-full h-16 bg-transparent text-white font-mono text-lg focus:outline-none placeholder-gray-600">
                <div class="hidden md:flex gap-1">
                    <span class="text-[10px] font-mono text-gray-500 border border-gray-800 px-1 rounded">ESC</span>
                </div>
            </div>

            <div id="cmd-results" class="max-h-[60vh] overflow-y-auto p-2">
                </div>

            <div class="px-4 py-2 bg-gray-900/50 border-t border-gray-800 flex justify-between items-center text-[10px] font-mono text-gray-500">
                <span>AURELIA_INDEX_V3.2</span>
                <span id="cmd-count">0 NODES CONNECTED</span>
            </div>
        </div>
    </div>

    <script>
        /* --- COMMAND PALETTE LOGIC --- */
        // 1. Ingest the Python-generated Index (Safe injection)
        const SYSTEM_INDEX = {{ search_index | safe }}; 
        
        const cmdBackdrop = document.getElementById('cmd-backdrop');
        const cmdPanel = document.getElementById('cmd-panel');
        const cmdInput = document.getElementById('cmd-input');
        const cmdResults = document.getElementById('cmd-results');
        const cmdCount = document.getElementById('cmd-count');
        let isOpen = false;

        // Update footer count
        if(cmdCount) cmdCount.innerText = `${SYSTEM_INDEX.length} NODES CONNECTED`;

        // 2. Open/Close Logic
        function toggleCmd() {
            isOpen = !isOpen;
            if(isOpen) {
                cmdBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    cmdBackdrop.classList.remove('opacity-0');
                    cmdPanel.classList.remove('scale-95');
                    cmdPanel.classList.add('scale-100');
                    cmdInput.focus();
                }, 10);
                document.body.style.overflow = 'hidden';
            } else {
                cmdBackdrop.classList.add('opacity-0');
                cmdPanel.classList.remove('scale-100');
                cmdPanel.classList.add('scale-95');
                setTimeout(() => {
                    cmdBackdrop.classList.add('hidden');
                    cmdInput.value = ''; // Clear input
                    renderResults([]); // Clear results
                }, 200);
                document.body.style.overflow = 'auto';
            }
        }

        // 3. Event Listeners (CMD+K)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                toggleCmd();
            }
            if (e.key === 'Escape' && isOpen) toggleCmd();
        });

        // Close on click outside
        cmdBackdrop.addEventListener('click', (e) => {
            if(e.target === cmdBackdrop) toggleCmd();
        });

        // 4. Search Engine (UPDATED)
        cmdInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if(query.length < 1) {
                cmdResults.innerHTML = `<div class="text-center py-8 text-gray-600 font-mono text-sm opacity-50">... AWAITING INPUT ...</div>`;
                return;
            }

            // SMART FILTER: Checks Title, Type, AND Tags
            const matches = SYSTEM_INDEX.filter(item => {
                const titleMatch = item.title.toLowerCase().includes(query);
                const typeMatch = item.type.toLowerCase().includes(query);
                const tagMatch = item.tags && item.tags.some(t => t.toLowerCase().includes(query));
                const descMatch = item.desc && item.desc.toLowerCase().includes(query);
                
                return titleMatch || typeMatch || tagMatch || descMatch;
            }).slice(0, 8);

            renderResults(matches);
        });

        function renderResults(results) {
            if(results.length === 0 && cmdInput.value.length > 0) {
                cmdResults.innerHTML = `<div class="p-4 text-center font-mono text-gray-500">> NO_MATCHES_FOUND_IN_VAULT</div>`;
                return;
            }

            // Render List
            cmdResults.innerHTML = results.map((item, index) => {
                // Color coding based on type
                let typeColor = "text-gray-500 border-gray-700";
                if(item.type === "PROJECT") typeColor = "text-aurelia-purple border-aurelia-purple/50";
                if(item.type === "GARDEN" || item.type === "NOTE") typeColor = "text-aurelia-cyan border-aurelia-cyan/50";
                if(item.type === "PROTOCOL") typeColor = "text-aurelia-green border-aurelia-green/50";
                
                return `
                <a href="${item.url}" class="group flex items-center justify-between p-3 rounded-md hover:bg-white/5 hover:border-l-2 hover:border-aurelia-cyan cursor-pointer transition-all border-l-2 border-transparent">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-mono uppercase px-1.5 py-0.5 rounded border ${typeColor} w-20 text-center">
                            ${item.type}
                        </span>
                        <span class="font-bold text-gray-300 group-hover:text-white font-mono">${item.title}</span>
                    </div>
                    <span class="text-gray-600 text-xs font-mono group-hover:text-aurelia-cyan">JUMP -></span>
                </a>
                `;
            }).join('');
        }
    </script>
</body>
</html>