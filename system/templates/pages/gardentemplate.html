{% extends "base.html" %}

{% set active_page = "garden" %}
{% block nav_title %}GARDEN_DECK{% endblock %}

{% block head_extra %}
<style>
    /* 1. SEARCH HIGHLIGHTING (PRESERVED) */
    .highlight {
        background-color: rgba(238, 241, 30, 0.966);
        color: white; 
        font-weight: bold;
        border-radius: 2px;
        padding: 0 2px;
    }

    /* 2. THE AURELIA ATMOSPHERE (PRESERVED) */
    .scanline {
        width: 100%; height: 100px; z-index: 40;
        background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255,255,255,0.02) 50%, rgba(0,0,0,0) 100%);
        opacity: 0.1; position: fixed; pointer-events: none; animation: scanline 8s linear infinite;
    }

    /* 3. CARD PHYSICS (PRESERVED) */
    .glass:hover {
        background: rgba(255, 255, 255, 0.03); 
    }

    /* 4. ACTIVE BUTTON STATE (PRESERVED) */
    .filter-btn.active {
        background: rgba(255,255,255,0.1);
        border-color: white;
        color: white;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    /* 5. TREE VIEW ARCHITECTURE (UPGRADED) */
    .tree-container {
        font-family: 'JetBrains Mono', monospace;
        padding-left: 0.5rem;
    }
    
    /* The Folder Header */
    details > summary {
        list-style: none; cursor: pointer; transition: all 0.2s;
        border: 1px solid transparent; border-radius: 4px;
        position: relative; z-index: 10;
    }
    details > summary::-webkit-details-marker { display: none; }
    details > summary:hover {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.1);
    }
    /* Folder Open Animation */
    details[open] > summary .folder-arrow { transform: rotate(90deg); }
    details[open] > summary { margin-bottom: 0.5rem; }

    /* The Vertical Circuit Line */
    .tree-branch {
        position: relative;
        margin-left: 1.1rem; /* Aligns with folder icon */
        padding-left: 1.5rem;
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        transition: border-color 0.3s ease;
    }
    /* Glow the line when hovering the branch */
    .tree-branch:hover { border-left-color: rgba(0, 242, 255, 0.3); }

    /* The File Row */
    .tree-node {
        position: relative;
        display: flex; justify-content: space-between; align-items: center;
        padding: 6px 12px; margin-bottom: 2px;
        border-radius: 2px; border: 1px solid transparent;
        transition: all 0.2s;
    }
    /* Hover Effect: The "Active State" */
    .tree-node:hover {
        background: rgba(0, 242, 255, 0.05);
        border-color: rgba(0, 242, 255, 0.2);
        box-shadow: 0 0 15px rgba(0, 242, 255, 0.05); 
    }

    /* The Horizontal Connector Line */
    .tree-node::before {
        content: ''; position: absolute; 
        left: -1.5rem; top: 50%;
        width: 1rem; height: 1px;
        background: rgba(255, 255, 255, 0.1);
        transition: background 0.2s;
    }
    .tree-branch:hover .tree-node::before { background: rgba(0, 242, 255, 0.3); }

    /* The Connector Dot (The Node) */
    .tree-node::after {
        content: ''; position: absolute;
        left: -1.65rem; top: calc(50% - 2px);
        width: 4px; height: 4px;
        background: #000;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        z-index: 5;
    }
    .tree-branch:hover .tree-node::after { border-color: #00f2ff; background: #00f2ff; box-shadow: 0 0 5px #00f2ff; }

    /* 6. OBSIDIAN READER ENGINE (PRESERVED) */
    .obsidian-reader { font-family: 'Inter', sans-serif; color: #dcddde; line-height: 1.6; }
    .obsidian-reader h1, .obsidian-reader h2, .obsidian-reader h3 { color: {{ theme.colors.text_main|replace("'", "") }}; font-weight: 600; margin-top: 1.5em; }
    .obsidian-reader h1 { font-size: 2em; border-bottom: 1px solid {{ theme.colors.border_main|replace("'", "") }}; pb-2; }
    .obsidian-reader a { color: {{ theme.colors.primary|replace("'", "") }}; text-decoration: none; }
    .obsidian-reader a:hover { opacity: 0.8; text-decoration: underline; }
    .obsidian-reader pre { background-color: #121212; border: 1px solid #2a2a2a; border-radius: 4px; padding: 16px; overflow-x: auto; margin: 1.5em 0; }
    .obsidian-reader code { font-family: 'JetBrains Mono', monospace; background-color: rgba(255,255,255,0.05); padding: 2px 4px; color: {{ theme.colors.accent|replace("'", "") }}; }
    .obsidian-reader blockquote { border-left: 4px solid {{ theme.colors.secondary|replace("'", "") }}; background-color: rgba(138, 43, 226, 0.05); padding: 12px 16px; margin: 1.5em 0; }
    .obsidian-reader img { max-width: 100%; border: 1px solid {{ theme.colors.border_main|replace("'", "") }}; border-radius: 4px; }
    .obsidian-reader ul, .obsidian-reader ol { padding-left: 2em; margin: 1em 0; }
</style>
{% endblock %}

{% block content %}
   <div class="scanline"></div>

    <div class="fixed top-14 left-0 w-full z-50 bg-aurelia-dark/90 backdrop-blur border-b border-aurelia-dim py-4 px-6 shadow-2xl">
        <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex items-center gap-4 overflow-x-auto w-full md:w-auto pb-2 md:pb-0 no-scrollbar">
                
                <div class="flex items-center bg-black/50 border border-gray-800 rounded p-1 shrink-0">
                    <button onclick="switchView('grid')" id="btn-grid" class="p-2 rounded text-aurelia-primary bg-white/10 transition-all hover:text-white" title="Grid View">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    </button>
                    <button onclick="switchView('tree')" id="btn-tree" class="p-2 rounded text-gray-500 hover:text-white transition-all" title="Tree View">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>

                <div class="h-6 w-px bg-gray-800 shrink-0"></div>

                <div id="filter-controls" class="flex gap-2 transition-opacity duration-300">
                    <button onclick="setFilter('all')" class="filter-btn active px-5 py-2 text-sm font-mono border border-aurelia-primary bg-aurelia-primary/10 text-aurelia-primary rounded uppercase tracking-wider transition-all whitespace-nowrap">
                        All_Notes
                    </button>

                    <button onclick="setFilter('daily-bridge')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-aurelia-tertiary hover:border-aurelia-tertiary hover:bg-aurelia-tertiary/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        Daily Logs
                    </button>

                    <button onclick="setFilter('concept')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-aurelia-primary hover:border-aurelia-primary hover:bg-aurelia-primary/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        Concepts
                    </button>

                    <button onclick="setFilter('source')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-yellow-400 hover:border-yellow-400 hover:bg-yellow-400/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        Library
                    </button>

                    <button onclick="setFilter('author')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-aurelia-secondary hover:border-aurelia-secondary hover:bg-aurelia-secondary/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        Authors
                    </button>

                    <button onclick="setFilter('discipline')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-aurelia-accent hover:border-aurelia-accent hover:bg-aurelia-accent/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        Disciplines
                    </button>

                    <button onclick="setFilter('notebooklm')" class="filter-btn px-5 py-2 text-sm font-mono border border-gray-800 text-gray-500 hover:text-indigo-500 hover:border-indigo-500 hover:bg-indigo-500/5 rounded transition-all uppercase tracking-wider whitespace-nowrap">
                        NotebookLM
                </div>
            </div>
            
            <div class="flex items-center gap-3 border border-aurelia-dim bg-black/50 rounded px-4 py-2 w-full md:w-96">
                <span class="text-xs opacity-50 font-mono">CMD://</span>
                <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="SEARCH_DATABASE..." class="bg-transparent border-none text-xs font-mono text-aurelia-primary focus:outline-none w-full placeholder-gray-200">
            </div>
        </div>
    </div>

    <div class="flex-grow pt-12 pb-20 px-6 w-full max-w-[1600px] mx-auto">
        
        <div class="w-full max-w-[1600px] mx-auto mb-10 relative group rounded-sm overflow-hidden border border-gray-400 bg-black h-64">
            <canvas id="neural-canvas" class="absolute inset-0 w-full h-full z-0 opacity-70"></canvas>
            <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 bg-[length:100%_2px,3px_100%] pointer-events-none"></div>
            <div class="absolute inset-0 bg-radial-gradient(circle at center, transparent 0%, #000000 100%) z-10 opacity-50 pointer-events-none"></div>
            <div class="absolute bottom-6 left-8 z-20 pointer-events-none">
                <h1 class="text-5xl font-black text-aurelia-text font-mono tracking-tighter drop-shadow-[0_0_15px_rgba(0,242,255,0.3)]">DIGITAL_GARDEN</h1>
                <p class="text-xs text-aurelia-primary font-mono mt-2 tracking-[0.3em] flex items-center gap-3">
                    <span class="w-2 h-2 bg-aurelia-primary rounded-full animate-pulse shadow-[0_0_10px_#00f2ff]"></span>
                    SYSTEM STATUS: ONLINE // VIEW: <span id="view-mode-label">GRID_MATRIX</span>
                </p>
            </div>
        </div>

        <div class="mb-8 flex justify-between items-end border-b border-aurelia-dim pb-4">
            <p class="text-md font-mono text-gray-100 tracking-widest">
                // TOTAL_NODES: <span id="node-count" class="text-aurelia-text">{{ cards|length }}</span>
            </p>
        </div>

        <div id="cardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20 auto-rows-fr">
            {% for card in cards %}
                {{ card.html|safe }}
            {% endfor %}
        </div>

        <div id="treeView" class="hidden animate-fade-in-up">
            <div class="max-w-5xl border-l border-gray-800 ml-4 pl-8 pt-6 pb-20">
                
                {% for type, group in cards|groupby('type') %}
                    
                    {% set group_color = "text-gray-500" %}
                    {% set group_border = "border-gray-800" %}
                    {% set folder_icon = "üìÅ" %}
                    
                    {% if "concept" in type %} 
                        {% set group_color = "text-aurelia-primary" %} 
                        {% set group_border = "border-aurelia-primary" %}
                        {% set folder_icon = "üß¨" %}
                    {% endif %}
                    
                    {% if "daily" in type or "log" in type %} 
                        {% set group_color = "text-aurelia-tertiary" %} 
                        {% set group_border = "border-aurelia-tertiary" %}
                        {% set folder_icon = "üìÖ" %}
                    {% endif %}
                    
                    {% if "source" in type %} 
                        {% set group_color = "text-yellow-400" %} 
                        {% set group_border = "border-yellow-400" %}
                        {% set folder_icon = "üìö" %}
                    {% endif %}

                    {% if "author" in type %} 
                        {% set group_color = "text-aurelia-secondary" %} 
                        {% set group_border = "border-aurelia-secondary" %}
                        {% set folder_icon = "üë§" %}
                    {% endif %}

                    <details class="mb-6 group tree-folder" open data-type="{{ type|lower }}">
                        <summary class="flex items-center gap-4 py-2 px-3 select-none cursor-pointer">
                            <div class="folder-arrow text-gray-600 transition-transform duration-200">‚ñ∂</div>
                            
                            <div class="flex items-center gap-3">
                                <span class="text-lg opacity-80">{{ folder_icon }}</span>
                                <span class="text-sm font-bold font-mono {{ group_color }} uppercase tracking-[0.2em]">{{ type|replace('-', ' ') }}</span>
                            </div>
                            
                            <div class="h-px bg-gray-800 flex-grow mx-4 opacity-50"></div>
                            
                            <span class="text-[10px] text-gray-400 font-mono border border-gray-800 bg-black px-2 py-0.5 rounded">
                                {{ group|length }} NODES
                            </span>
                        </summary>

                        <div class="tree-branch space-y-1 mt-2">
                            {% for card in group %}
                            <div class="tree-node group/node cursor-pointer searchable-tree-item" 
                                 onclick="openNote('{{ card.id }}')"
                                 data-type="{{ card.type|lower }}"
                                 data-search="{{ card.title }} {{ card.desc }}">
                                
                                <div class="flex items-center gap-3 overflow-hidden">
                                    <span class="text-gray-700 text-[10px] group-hover/node:text-aurelia-primary transition-colors font-mono">::</span>
                                    <span class="text-sm font-mono text-gray-400 group-hover/node:text-white transition-colors truncate">{{ card.title }}</span>
                                </div>

                                <div class="hidden md:flex items-center gap-4 opacity-0 group-hover/node:opacity-100 transition-all transform translate-x-2 group-hover/node:translate-x-0">
                                    
                                    <div class="flex gap-1">
                                        {% for tag in card.tags[:2] %}
                                        <span class="text-[9px] font-mono text-gray-500 border border-gray-800 px-1.5 py-0.5 rounded bg-black">#{{ tag }}</span>
                                        {% endfor %}
                                    </div>

                                    <div class="flex items-center gap-1 text-[9px] font-bold text-aurelia-primary tracking-wider">
                                        <span>ACCESS</span>
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                {% endfor %}
            </div>
        </div>

    </div>

    <div id="data-storage" style="display: none;">
        {% for card in cards %}
            <div id="{{ card.id }}" class="hidden">{{ card.body | safe }}</div>
        {% endfor %}
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center opacity-0 transition-opacity duration-300" onclick="closeModal()">
        <div id="modal-panel" class="bg-[#0a0a0b] border border-gray-800 w-full max-w-[90vw] h-[90vh] rounded-lg shadow-2xl flex flex-col transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center px-6 py-3 border-b border-gray-800 bg-[#111111]">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-red-500 rounded-full hover:bg-red-400 cursor-pointer" onclick="closeModal()"></div>
                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="ml-4 text-xs font-mono text-gray-500 uppercase tracking-widest">OBSIDIAN_VIEWER // ACTIVE</span>
                </div>
                <div class="text-[10px] font-mono text-gray-600">CMD+ESC TO CLOSE</div>
            </div>
            <div class="flex-grow overflow-y-auto bg-[#0a0a0b] custom-scrollbar">
                <div class="max-w-5xl mx-auto px-8 py-12">
                    <div id="modal-content" class="obsidian-reader text-lg"></div>
                </div>
            </div>
            <div class="px-4 py-2 border-t border-gray-800 bg-[#111111] flex justify-between items-center text-[10px] font-mono text-gray-600">
                <span>MODE: READ_ONLY</span>
                <span>AURELIA_OS V3.0</span>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. VIEW SWITCHER LOGIC (NEW) ---
    const gridView = document.getElementById('cardGrid');
    const treeView = document.getElementById('treeView');
    const btnGrid = document.getElementById('btn-grid');
    const btnTree = document.getElementById('btn-tree');
    const filterControls = document.getElementById('filter-controls');
    const viewLabel = document.getElementById('view-mode-label');

    function switchView(mode) {
        if(mode === 'grid') {
            gridView.classList.remove('hidden');
            treeView.classList.add('hidden');
            
            btnGrid.classList.add('bg-white/10', 'text-aurelia-primary');
            btnGrid.classList.remove('text-gray-500');
            btnTree.classList.remove('bg-white/10', 'text-aurelia-primary');
            btnTree.classList.add('text-gray-500');
            
            viewLabel.innerText = "GRID_MATRIX";
        } else {
            gridView.classList.add('hidden');
            treeView.classList.remove('hidden');
            
            btnTree.classList.add('bg-white/10', 'text-aurelia-primary');
            btnTree.classList.remove('text-gray-500');
            btnGrid.classList.remove('bg-white/10', 'text-aurelia-primary');
            btnGrid.classList.add('text-gray-500');
            
            viewLabel.innerText = "TREE_DIRECTORY";
        }
        // DELETED: The lines that set filterControls.style.opacity/pointerEvents
        // Filters now remain active in both modes.
    }

    // --- 2. NEURAL ANIMATION (PRESERVED) ---
    (function() {
        const canvas = document.getElementById('neural-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const particleCount = 60; 
        const connectionDistance = 150; 
        const mouseDistance = 200; 

        function resize() { width = canvas.width = canvas.parentElement.offsetWidth; height = canvas.height = canvas.parentElement.offsetHeight; }
        window.addEventListener('resize', resize);
        resize();

        const mouse = { x: null, y: null };
        canvas.parentElement.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });
        canvas.parentElement.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

        class Particle {
            constructor() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.20; this.vy = (Math.random() - 0.5) * 0.20;
                this.size = Math.random() * 1.5 + 0.5;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
                if (mouse.x != null) {
                    let dx = mouse.x - this.x; let dy = mouse.y - this.y;
                    let distance = Math.sqrt(dx*dx + dy*dy);
                    if (distance < mouseDistance) {
                        const force = (mouseDistance - distance) / mouseDistance;
                        this.vx -= (dx / distance) * force * 0.5;
                        this.vy -= (dy / distance) * force * 0.5;
                    }
                }
            }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = 'rgba(0, 242, 255, 0.5)'; ctx.fill(); }
        }
        for (let i = 0; i < particleCount; i++) particles.push(new Particle());

        function animate() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            for (let a = 0; a < particles.length; a++) {
                for (let b = a; b < particles.length; b++) {
                    let dx = particles[a].x - particles[b].x; let dy = particles[a].y - particles[b].y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < connectionDistance) {
                        ctx.strokeStyle = `rgba(0, 242, 255, ${1 - (distance / connectionDistance)})`;
                        ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(particles[a].x, particles[a].y); ctx.lineTo(particles[b].x, particles[b].y); ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animate);
        }
        animate();
    })();

    // --- 3. FILTER & SEARCH (ADDITIVE DEEP SEARCH) ---
    let currentType = 'all';
    let currentQuery = '';
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalPanel = document.getElementById('modal-panel');
    const modalContent = document.getElementById('modal-content');

    function handleSearch() {
        const input = document.getElementById('searchInput');
        currentQuery = input.value.toLowerCase().trim();
        updateGrid();
    }

    function setFilter(type) {
        currentType = type;
        
        // 1. Reset All Buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            // Remove generic active styles
            btn.classList.remove('active');
            
            // Remove color-specific active styles (Clean Sweep)
            btn.classList.remove(
                'bg-aurelia-primary/10', 'text-aurelia-primary', 'border-aurelia-primary',
                'bg-aurelia-tertiary/10', 'text-aurelia-tertiary', 'border-aurelia-tertiary',
                'bg-aurelia-secondary/10', 'text-aurelia-secondary', 'border-aurelia-secondary',
                'bg-aurelia-accent/10', 'text-aurelia-accent', 'border-aurelia-accent',
                'bg-yellow-400/10', 'text-yellow-400', 'border-yellow-400',
                'bg-indigo-400/10', 'text-indigo-400', 'border-indigo-400'
            );

            // Add inactive state
            btn.classList.add('border-gray-800', 'text-gray-500');
        });

        // 2. Activate Target Button
        const target = event.target; // Using the global event object from onclick
        target.classList.remove('border-gray-800', 'text-gray-500');
        target.classList.add('active');

        // 3. Apply Dynamic Color Scheme
        if (type === 'daily-bridge') {
            target.classList.add('bg-aurelia-tertiary/10', 'text-aurelia-tertiary', 'border-aurelia-tertiary');
        } else if (type === 'source') {
            target.classList.add('bg-yellow-400/10', 'text-yellow-400', 'border-yellow-400');
        } else if (type === 'author') {
            target.classList.add('bg-aurelia-secondary/10', 'text-aurelia-secondary', 'border-aurelia-secondary');
        } else if (type === 'discipline') {
            target.classList.add('bg-aurelia-accent/10', 'text-aurelia-accent', 'border-aurelia-accent');
        } else if (type === 'notebooklm') {
            // NEW: Indigo Theme for AI Research
            target.classList.add('bg-indigo-400/10', 'text-indigo-400', 'border-indigo-400');
        } else {
            // Default (All, Concepts) -> Cyan
            target.classList.add('bg-aurelia-primary/10', 'text-aurelia-primary', 'border-aurelia-primary');
        }
        
        updateGrid();
    }

    function updateGrid() {
        let visibleCount = 0;

        // 1. FILTER GRID ITEMS
        const gridItems = document.querySelectorAll('.searchable-item');
        gridItems.forEach(item => {
            if (checkVisibility(item)) {
                item.style.display = 'flex';
                visibleCount++;
                // Additive Highlight: Only highlight if there is a query
                if (currentQuery.length > 0) highlightText(item, currentQuery);
                else clearHighlights(item);
            } else {
                item.style.display = 'none';
                clearHighlights(item);
            }
        });

        // 2. FILTER TREE NODES
        const treeNodes = document.querySelectorAll('.searchable-tree-item');
        treeNodes.forEach(item => {
            if (checkVisibility(item)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });

        // 3. AUTO-HIDE EMPTY FOLDERS
        const treeFolders = document.querySelectorAll('.tree-folder'); 
        treeFolders.forEach(folder => {
            const children = folder.querySelectorAll('.searchable-tree-item');
            let hasVisible = false;
            children.forEach(c => { if(c.style.display !== 'none') hasVisible = true; });

            if (hasVisible) folder.style.display = 'block';
            else folder.style.display = 'none';
        });

        const counter = document.getElementById('node-count');
        if (counter) counter.innerText = visibleCount;
    }

    // HELPER: Centralized Logic (The Brain)
    function checkVisibility(item) {
        // dataset.search now contains the FULL BODY TEXT (Deep Search)
        const itemType = item.dataset.type ? item.dataset.type.toLowerCase() : '';
        const itemSearch = item.dataset.search ? item.dataset.search.toLowerCase() : '';
        
        // ADDITIVE LOGIC: Must match Filter Button AND Search Bar
        const typeMatch = (currentType === 'all') || (itemType.includes(currentType));
        const searchMatch = itemSearch.includes(currentQuery);

        return typeMatch && searchMatch;
    }

    // --- ROBUST HIGHLIGHTING ENGINE ---
    function highlightText(card, term) {
        // Only target Visible elements (h3, p) to avoid breaking layout/icons
        const targets = card.querySelectorAll('h3, p');
        targets.forEach(element => {
            if (!element.dataset.original) element.dataset.original = element.innerHTML;
            const originalHTML = element.dataset.original;
            
            // Only highlight if the VISIBLE text actually contains the term
            if (originalHTML.toLowerCase().includes(term)) {
                // ‚ö° SMART REGEX ‚ö°: Ignores text inside HTML tags (like <button> or class="")
                const regex = new RegExp(`(?![^<]*>)(${term})`, 'gi');
                element.innerHTML = originalHTML.replace(regex, '<span class="highlight">$1</span>');
            } else {
                element.innerHTML = originalHTML;
            }
        });
    }

    function clearHighlights(card) {
        const targets = card.querySelectorAll('h3, p');
        targets.forEach(element => {
            if (element.dataset.original) element.innerHTML = element.dataset.original;
        });
    }

    function openNote(noteId) {
        const rawEl = document.getElementById(noteId);
        if (!rawEl) return;
        const txt = document.createElement("textarea");
        txt.innerHTML = rawEl.innerHTML;
        modalContent.innerHTML = marked.parse(txt.value);
        modalBackdrop.classList.remove('hidden');
        setTimeout(() => { modalBackdrop.classList.remove('opacity-0'); modalPanel.classList.remove('scale-95'); modalPanel.classList.add('scale-100'); }, 10);
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modalBackdrop.classList.add('opacity-0');
        modalPanel.classList.remove('scale-100');
        modalPanel.classList.add('scale-95');
        setTimeout(() => { modalBackdrop.classList.add('hidden'); }, 300);
        document.body.style.overflow = 'auto';
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
</script>
{% endblock %}